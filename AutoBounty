local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local PlaceId =game.PlaceId

local teleporting = false
local isEscaping = false

player:WaitForChild("DataLoaded", 30)

local function safeTeleport()
	--[[pcall(function()
		if writefile then
			writefile("BloxFruits/BlacklistedServer.json", HttpService:JSONEncode({serverId = game.JobId}))
		end
	end)--]]
	local PlaceID = game.PlaceId
	local AllIDs = {}
	local foundAnything = ""
	local actualHour = os.date("!*t").hour
	local Deleted = false
	function TPReturner()
		local Site;
		if foundAnything == "" then
			Site = game.HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100'))
		else
			Site = game.HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100&cursor=' .. foundAnything))
		end        
		local ID = ""
		if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
			foundAnything = Site.nextPageCursor
		end        
		local num = 0
		for i,v in pairs(Site.data) do
			local Possible = true
			ID = tostring(v.id)            
			if tonumber(v.maxPlayers) > tonumber(v.playing) then
				for _,Existing in pairs(AllIDs) do
					if num ~= 0 then
						if ID == tostring(Existing) then
							Possible = false
						end
					else
						if tonumber(actualHour) ~= tonumber(Existing) then
							local delFile = pcall(function()
								AllIDs = {}
								table.insert(AllIDs, actualHour)
							end)
						end
					end
					num = num + 1
				end
				if Possible == true then
					table.insert(AllIDs, ID)
					wait(0.1)
					pcall(function()
						game:GetService("TeleportService"):TeleportToPlaceInstance(PlaceID, ID, game.Players.LocalPlayer)
					end)
					wait(1)
					break
				end
			end
		end
	end
	function Teleport() 
		while true do
			pcall(function()
				TPReturner()
				if foundAnything ~= "" then
					TPReturner()
				end
			end)
			wait(1)
		end
	end
	Teleport()
end

local trackerData = {
	initialBounty = 0,
	startTime = 0
}

local function saveTracker()
	pcall(function()
		if writefile then
			writefile("BloxFruits/BountyTracker.json", HttpService:JSONEncode(trackerData))
		end
	end)
end

local function loadTracker()
	local success, result = pcall(function()
		if isfile and isfile("BloxFruits/BountyTracker.json") then
			return HttpService:JSONDecode(readfile("BloxFruits/BountyTracker.json"))
		end
	end)

	if success and result and result.initialBounty and result.startTime then
		trackerData.initialBounty = result.initialBounty
		trackerData.startTime = result.startTime
	else
		local bounty = player:WaitForChild("leaderstats", 10):WaitForChild("Bounty/Honor", 10)
		trackerData.initialBounty = bounty and bounty.Value or 0
		trackerData.startTime = tick()
		saveTracker()
	end
end

local function getCurrentBounty()
	local bounty = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Bounty/Honor")
	return bounty and bounty.Value or trackerData.initialBounty
end

local function getBountyIncrease()
	return getCurrentBounty() - trackerData.initialBounty
end

local function getElapsedTime()
	local elapsed = tick() - trackerData.startTime
	local minutes = math.floor(elapsed / 60)
	local seconds = math.floor(elapsed % 60)
	return string.format("%02d:%02d", minutes, seconds)
end

local function resetTracker()
	local bounty = player:WaitForChild("leaderstats", 10):WaitForChild("Bounty/Honor", 10)
	trackerData.initialBounty = bounty and bounty.Value or 0
	trackerData.startTime = tick()
	saveTracker()
end

loadTracker()

local blacklist = {}

local function isInBlacklist(plr)
	return blacklist[plr] == true
end

local function addToBlacklist(plr)
	blacklist[plr] = true
end


local ESCAPE_SPEED = 350
local ESCAPE_HEIGHT = 350
local HEALTH_THRESHOLD = 0.25
local followPlatform = nil
local currentTween = nil
local followConnection = nil
local currentTarget = nil

local function createFollowPlatform(position)
	if followPlatform then
		followPlatform:Destroy()
	end
	followPlatform = Instance.new("Part")
	followPlatform.Size = Vector3.new(4, 1, 4)
	followPlatform.Anchored = true
	followPlatform.CanCollide = false
	followPlatform.Transparency = 1
	followPlatform.Position = position
	followPlatform.Parent = workspace
end

local function destroyFollowPlatform()
	if followPlatform then
		followPlatform:Destroy()
		followPlatform = nil
	end
	if followConnection then
		followConnection:Disconnect()
		followConnection = nil
	end
	if currentTween then
		currentTween:Cancel()
		currentTween = nil
	end
end

local function startEscape(char)
	if isEscaping or teleporting then return end
	isEscaping = true

	if currentTarget then
		addToBlacklist(currentTarget)
		currentTarget = nil
	end

	local hrp = char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	destroyFollowPlatform()
	createFollowPlatform(hrp.Position - Vector3.new(0, 2.5, 0))

	local targetPos = hrp.Position + Vector3.new(0, 10000, 0)
	local distance = (targetPos - followPlatform.Position).Magnitude
	local time = distance / ESCAPE_SPEED

	currentTween = game:GetService("TweenService"):Create(
		followPlatform,
		TweenInfo.new(time, Enum.EasingStyle.Linear),
		{Position = targetPos}
	)

	followConnection = RunService.Heartbeat:Connect(function()
		if (not isEscaping or not followPlatform or not hrp.Parent) and not teleporting then
			isEscaping = false
			destroyFollowPlatform()
			return
		end
		hrp.CFrame = CFrame.new(followPlatform.Position + Vector3.new(0, 2.5, 0))
	end)

	currentTween.Completed:Connect(function()
		isEscaping = false
		destroyFollowPlatform()
	end)

	currentTween:Play()
end


local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BountyTrackerGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("ImageLabel")
frame.Size = UDim2.new(0, 560, 0, 280)
frame.AnchorPoint = Vector2.new(0.5,0.5)
frame.Position = UDim2.new(0.5, 0, 0.5, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 2
frame.Image = "rbxassetid://76779713443091"
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui
local uiConner = Instance.new("UICorner", frame)
uiConner.CornerRadius = UDim.new(0.05, 0)
local uiStroke = Instance.new("UIStroke", frame)
uiStroke.Color = Color3.fromRGB(255, 255, 255)
uiStroke.Thickness = 2.5
uiStroke.Transparency = 0
local uiGradient = Instance.new("UIGradient", frame)
uiGradient.Color = ColorSequence.new({
	ColorSequenceKeypoint.new(0, Color3.fromRGB(170, 255, 255)),
	ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 255, 255)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(170, 255, 255))
})

local title = Instance.new("TextLabel")
title.Size = UDim2.new(0.8, 0, 0.14, 0)
title.Position = UDim2.new(0.1,0,0,0)
title.BackgroundTransparency = 1
title.TextStrokeTransparency =0
title.Text = "Yoru Hub Auto Bounty"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.Parent = frame

local boutyStateLabel = Instance.new("TextLabel")
boutyStateLabel.Name = "BountyStateLabel"
boutyStateLabel.Size = UDim2.new(0.2,0,0.2,0)
boutyStateLabel.Position = UDim2.new(0.1,0,0.2,0)
boutyStateLabel.BackgroundTransparency = 1
boutyStateLabel.TextStrokeTransparency =0.5
boutyStateLabel.Text = "Current Bounty :Loading..."
boutyStateLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
boutyStateLabel.Font = Enum.Font.FredokaOne
boutyStateLabel.TextXAlignment = Enum.TextXAlignment.Left
boutyStateLabel.TextSize =20
boutyStateLabel.Parent = frame

local bountyLabel = Instance.new("TextLabel")
bountyLabel.Name = "BountyLabel"
bountyLabel.Size = UDim2.new(0.2,0,0.2,0)
bountyLabel.Position = UDim2.new(0.1,0,0.3,0)
bountyLabel.BackgroundTransparency = 1
bountyLabel.TextStrokeTransparency =0.5
bountyLabel.Text = "Bounty Earned :Loading..."
bountyLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
bountyLabel.Font = Enum.Font.FredokaOne
bountyLabel.TextXAlignment = Enum.TextXAlignment.Left
bountyLabel.TextSize =20
bountyLabel.Parent = frame

local timeLabel = Instance.new("TextLabel")
timeLabel.Name = "TimeLabel"
timeLabel.Size = UDim2.new(0.2,0,0.2,0)
timeLabel.Position = UDim2.new(0.1,0,0.4,0)
timeLabel.BackgroundTransparency = 1
timeLabel.TextStrokeTransparency =0.5
timeLabel.Text = "Time: 00:00"
timeLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
timeLabel.Font = Enum.Font.FredokaOne
timeLabel.TextXAlignment = Enum.TextXAlignment.Left
timeLabel.TextSize = 20
timeLabel.Parent = frame

local hopStateLabel = Instance.new("TextLabel")
hopStateLabel.Name = "HopStateLabel"
hopStateLabel.Size = UDim2.new(0.2,0,0.2,0)
hopStateLabel.Position = UDim2.new(0.1,0,0.5,0)
hopStateLabel.BackgroundTransparency = 1
hopStateLabel.TextStrokeTransparency =0.5
hopStateLabel.Text = "Hop State: false"
hopStateLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
hopStateLabel.Font = Enum.Font.FredokaOne
hopStateLabel.TextXAlignment = Enum.TextXAlignment.Left
hopStateLabel.TextSize = 20
hopStateLabel.Parent = frame

local resetButton = Instance.new("TextButton")
resetButton.Size = UDim2.new(0.2, 0, 0.15, 0)
resetButton.Position = UDim2.new(0.77, 0, 0.8, 0)
resetButton.BackgroundColor3 = Color3.fromRGB(170, 255, 255)
resetButton.BackgroundTransparency = 0.6
resetButton.TextStrokeTransparency =0.5
resetButton.BorderSizePixel = 0
resetButton.Text = "Reset"
resetButton.TextColor3 = Color3.new(1, 1, 1)
resetButton.Font = Enum.Font.FredokaOne
resetButton.TextSize = 26
resetButton.Parent = frame
local uiConner = Instance.new("UICorner", resetButton)
uiConner.CornerRadius = UDim.new(0.3, 0)

resetButton.MouseButton1Click:Connect(resetTracker)

local hopButton = Instance.new("TextButton")
hopButton.Size = UDim2.new(0.2, 0, 0.15, 0)
hopButton.Position = UDim2.new(0.77, 0, 0.6, 0)
hopButton.BackgroundColor3 = Color3.fromRGB(170, 255, 255)
hopButton.BackgroundTransparency = 0.6
hopButton.TextStrokeTransparency =0.5
hopButton.BorderSizePixel = 0
hopButton.Text = "Server Hop"
hopButton.TextColor3 = Color3.new(1, 1, 1)
hopButton.Font = Enum.Font.FredokaOne
hopButton.TextSize = 26
hopButton.Parent = frame
local uiConner = Instance.new("UICorner", hopButton)
uiConner.CornerRadius = UDim.new(0.3, 0)

hopButton.MouseButton1Click:Connect(function()
	if not teleporting then
		teleporting = true
		task.spawn(function()
			startEscape()
		end)
		safeTeleport()
	end
end)

local toggleButton = Instance.new("ImageButton")
toggleButton.Size = UDim2.new(0, 50, 0, 50)
toggleButton.Position = UDim2.new(0, 100, 0, 100)
toggleButton.BackgroundTransparency = 1
toggleButton.Image = "rbxassetid://105537595237393"
toggleButton.Parent = screenGui
toggleButton.Active = true
toggleButton.Draggable = true
local toggleCorner = Instance.new("UICorner", toggleButton)
toggleCorner.CornerRadius = UDim.new(0.5, 0)
local uiStroke = Instance.new("UIStroke", toggleButton)
uiStroke.Color = Color3.fromRGB(85, 170, 255)
uiStroke.Thickness = 1.5
uiStroke.Transparency = 0

toggleButton.MouseButton1Click:Connect(function()
	frame.Visible = not frame.Visible
end)

spawn(function()
	task.wait(3)
	frame.Visible = false
end)

RunService.Heartbeat:Connect(function()
	local inc = getBountyIncrease()
	local currentBounty = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Bounty/Honor")

	boutyStateLabel.Text = "Current Bounty: " .. (currentBounty and currentBounty.Value or "Loading...")
	bountyLabel.Text = "Bounty Earned: " .. inc
	timeLabel.Text = "Time: " .. getElapsedTime()
	hopStateLabel.Text = "Hop State: " .. (teleporting and "Hopping..." or "No")
end)
task.spawn(function()
	task.wait(3)
	frame.Visible = false
end)

if not player.Character then
	ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", getgenv().Setting.Team)
	player.CharacterAdded:Wait()
end

local function checkPvpAndHop()	
	local pvp = player:GetAttribute("PvpDisabled")
	if pvp == true and not teleporting then
		teleporting = true
		task.spawn(function()
			startEscape()
		end)
		safeTeleport()
		
	end
end

player.CharacterAdded:Connect(checkPvpAndHop)

local function isInSafeZone(plr)
	if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
		return false
	end
	local root = plr.Character.HumanoidRootPart
	local safeZones = workspace:FindFirstChild("_WorldOrigin") and workspace._WorldOrigin:FindFirstChild("SafeZones")
	if not safeZones then return false end

	for _, zone in ipairs(safeZones:GetChildren()) do
		local mesh = zone:FindFirstChild("Mesh")
		if not mesh then continue end

		local distance = (root.Position - zone.Position).Magnitude
		if distance <= (zone.Size.X * mesh.Scale.X) / 2 then 
			return true
		end
	end
	return false
end

local targetStartTime = 0

local function findNewTarget()
	if isEscaping or teleporting then return end
	local myLevel = player:FindFirstChild("Data") and player.Data:FindFirstChild("Level")
	if not myLevel then return nil end

	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("Humanoid") then
			local hum = plr.Character.Humanoid
			local pvp = plr:GetAttribute("PvpDisabled")
			local targetLevel = plr:FindFirstChild("Data") and plr.Data:FindFirstChild("Level")

			if plr == currentTarget then
				if hum.Health > 0 then return plr end
				continue
			end

			if isInBlacklist(plr) then continue end

			if (pvp == nil or pvp == false) and targetLevel and not isInSafeZone(plr) then
				local diff = math.abs(myLevel.Value - targetLevel.Value)
				if diff <= myLevel.Value * 0.25 then
					return plr
				end
			end
		end
	end
	return nil
end

local function isTargetAlive(target)
	return target.Character and target.Character:FindFirstChild("Humanoid") and target.Character.Humanoid.Health > 0
end

local function isInCombat()
	local gui = player:FindFirstChild("PlayerGui")
	if not gui then return false end
	local main = gui:FindFirstChild("Main")
	if not main then return false end
	local hud = main:FindFirstChild("BottomHUDList")
	if not hud then return false end
	local combat = hud:FindFirstChild("InCombatBottom")
	if not combat then return false end
	return combat.Visible == true and combat.Text ~= "⚔️In Combat⚔️"
end

RunService.Heartbeat:Connect(function()
	local now = tick()

	if currentTarget then
		if not isTargetAlive(currentTarget) then
			addToBlacklist(currentTarget)
			currentTarget = nil
			targetStartTime = 0
		elseif now - targetStartTime >= getgenv().Setting.SkipTargetTime then
			addToBlacklist(currentTarget)
			currentTarget = nil
			targetStartTime = 0
		end
	end

	if not currentTarget then
		currentTarget = findNewTarget()
		if currentTarget then
			targetStartTime = now
		else
			if not isInCombat() and not teleporting then
				teleporting = true
				task.spawn(function()
					startEscape()
				end)
				safeTeleport()
			end
			return
		end
	end

	if isEscaping or teleporting then
		targetStartTime = 0
		return 
	end

	local myChar = player.Character
	local targetChar = currentTarget.Character
	if myChar and myChar:FindFirstChild("HumanoidRootPart") and targetChar and targetChar:FindFirstChild("HumanoidRootPart") then
		myChar.HumanoidRootPart.CFrame = targetChar.HumanoidRootPart.CFrame + Vector3.new(0, -0.5, 0)
	end
end)

local START_TIME = tick() 

spawn(function()
	while task.wait(1)  do
		local elapsed = tick() - START_TIME
		if elapsed >= getgenv().Setting.HopTime * 60 and not teleporting then
			teleporting = true
			task.spawn(function()
				startEscape()
			end)
			safeTeleport()
			break  
		end 
	end
end)

function EquipTool(Tool)
	pcall(function()
		game.Players.LocalPlayer.Character.Humanoid:EquipTool(game.Players.LocalPlayer.Backpack[Tool])
	end)
end

local SelectWeapon
spawn(function()
	while wait(.2) do
		for i ,v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
			if v.ToolTip == "Blox Fruit" then
				SelectWeapon = v.Name
				if not player.Character:FindFirstChild(SelectWeapon) then
					EquipTool(SelectWeapon)
				end
			end
		end
	end
end)

--[[player.CharacterAdded:Connect(function(char)
	char:WaitForChild("Humanoid")
	task.wait(1)

	local tool = player.Backpack:FindFirstChild(SelectWeapon)
	if tool then
		char.Humanoid:EquipTool(tool)
	end
end)]]--

local function IsEntityAlive(entity)
	if not entity then return false end
	local humanoid = entity:FindFirstChild("Humanoid")
	return humanoid and humanoid.Health > 0
end

local function GetEnemiesInRange(character, range)
	local enemies = game:GetService("Workspace").Enemies:GetChildren()
	local players = game:GetService("Players"):GetPlayers()
	local targets = {}
	local playerPos = character:GetPivot().Position
	for _, enemy in ipairs(enemies) do
		local rootPart = enemy:FindFirstChild("HumanoidRootPart")
		if rootPart and IsEntityAlive(enemy) then
			local distance = (rootPart.Position - playerPos).Magnitude
			if distance <= range then
				table.insert(targets, enemy)
			end
		end
	end
	for _, otherPlayer in ipairs(players) do
		if otherPlayer ~= player and otherPlayer.Character then
			local rootPart = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
			if rootPart and IsEntityAlive(otherPlayer.Character) then
				local distance = (rootPart.Position - playerPos).Magnitude
				if distance <= range then
					table.insert(targets, otherPlayer.Character)
				end
			end
		end
	end
	return targets
end

local attackRange = 60
local function attackNoCoolDown()
	local character = player.Character
	local hrp = character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	local equippedWeapon
	for _, item in ipairs(character:GetChildren()) do
		if item:IsA("Tool") then
			equippedWeapon = item
			break
		end
	end
	if not equippedWeapon then return end
	--[[if hrp:FindFirstChild("Buddha") then
		attackRange =1000
	else
		attackRange =60
	end]]--
	local enemiesInRange = GetEnemiesInRange(character, attackRange)
	if equippedWeapon:FindFirstChild("LeftClickRemote") then
		local attackCount = 1  
		for _, enemy in ipairs(enemiesInRange) do
			local rootPart = enemy:FindFirstChild("HumanoidRootPart")
			if rootPart then
				local direction = (rootPart.Position - character:GetPivot().Position).Unit
				equippedWeapon.LeftClickRemote:FireServer(direction, attackCount)
				attackCount = attackCount + 1
			end
		end
	else
		local targets, mainTarget = {}, nil
		for _, enemy in ipairs(enemiesInRange) do
			if not enemy:GetAttribute("IsBoat") then
				local head = enemy:FindFirstChild("Head")
				if head then
					table.insert(targets, { enemy, head })
					mainTarget = head
				end
			end
		end
		if mainTarget then
			local attackEvent = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net"):WaitForChild("RE/RegisterAttack")
			local hitEvent = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Net"):WaitForChild("RE/RegisterHit")
			pcall(function()
				attackEvent:FireServer(0.1)
				hitEvent:FireServer(mainTarget, targets)
			end)
		end
	end
end
task.spawn(function()
	while task.wait(0.1) do
		attackNoCoolDown()
	end
end)

task.spawn(function()
	while task.wait(1) do    
		pcall(function()
			game:GetService("ReplicatedStorage").Remotes.CommE:FireServer("ActivateAbility")
		end)
	end
end)

task.spawn(function()
	while task.wait(1) do
		local character = game.Players.LocalPlayer.Character
		if character and character:FindFirstChild("RaceEnergy") and
			character.RaceEnergy.Value >= 1 and
			not character.RaceTransformed.Value then
			local be = game:GetService("VirtualInputManager")
			be:SendKeyEvent(true, "Y", false, game)
			task.wait(0.1)
			be:SendKeyEvent(false, "Y", false, game)
		end
	end
end)

local function setupSitPrevention(char)
	local hum = char:WaitForChild("Humanoid")
	if not hum then return end

	hum:GetPropertyChangedSignal("Sit"):Connect(function()
		if hum.Sit then
			task.spawn(function()
				repeat
					task.wait(0.1)
					pcall(function()
						hum:ChangeState(Enum.HumanoidStateType.Jumping)
					end)
				until not hum.Sit or not hum.Parent
			end)
		end
	end)
end

spawn(function()
	while task.wait(1) do
		if not game.Players.LocalPlayer.Character:FindFirstChild("HasBuso") then
			game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("Buso")
		end
	end
end)

local function setupEscapeSystem(char)
	local hum = char:FindFirstChild("Humanoid")
	if not hum then return end

	hum.HealthChanged:Connect(function()
		if hum.Health > 0 and hum.Health / hum.MaxHealth <= HEALTH_THRESHOLD and isInCombat() then
			if not isEscaping then
				task.spawn(function()
					startEscape(char)
				end)
			end
		end
		if hum.Health > 0 and hum.Health / hum.MaxHealth >= 0.75 and isInCombat() then
			if isEscaping then
				isEscaping = false
			end
		end
	end)
end

if player.Character then
	setupEscapeSystem(player.Character)
	setupSitPrevention(player.Character)
end
player.CharacterAdded:Connect(function()
	setupSitPrevention(player.Character)
	setupEscapeSystem(player.Character)
end)
